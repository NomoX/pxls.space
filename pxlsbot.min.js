function UBot(t){t.ignore=t.ignore||[],t.priority=t.priority||[],t.dir=t.dir||0,t.pixelize=t.pixelize||!0,this.image=t}function launchBot(t){function e(){(App.cooldown-(new Date).getTime())/1e3>0?setTimeout(e,WAIT_DELAY):(a(),setTimeout(e,DRAW_DELAY))}function a(){t.board.data=updateBoardData(t.board);for(var e=0,a=0;a<t.template.data.width;a++)for(var r=0;r<t.template.data.height;r++){var p=o(a,r);null!=p&&e++}switch(l=100-e/n*100,s.updatePercent(l),d>0&&s.updateSpeed(d-e),s.updateFilled(e,n),d=e,t.image.dir){case 0:for(var c=[],a=0;a<t.template.data.width;a++)for(var r=0;r<t.template.data.height;r++){var p=o(a,r);null!=p&&c.push(p)}c.length>0&&i(c[Math.floor(Math.random()*c.length)]);break;case 1:for(var a=0;a<t.template.data.width;a++)for(var r=0;r<t.template.data.height;r++){var p=o(a,r);if(null!=p)return void i(p)}break;case 2:for(var a=t.template.data.width-1;a>0;a--)for(var r=0;r<t.template.data.height;r++){var p=o(a,r);if(null!=p)return void i(p)}break;case 3:for(var r=0;r<t.template.data.height;r++)for(var a=0;a<t.template.data.width;a++){var p=o(a,r);if(null!=p)return void i(p)}break;case 4:for(var r=t.template.data.height-1;r>0;r--)for(var a=0;a<t.template.data.width;a++){var p=o(a,r);if(null!=p)return void i(p)}break;case 5:for(var a=0;a<t.template.data.width;a++)for(var r=a%2;r<t.template.data.height;r+=2){var p=o(a,r);if(null!=p)return void i(p)}for(var a=0;a<t.template.data.width;a++)for(var r=1-a%2;r<t.template.data.height;r+=2){var p=o(a,r);if(null!=p)return void i(p)}break;default:console.warn("Unknown direction index")}}function o(e,a){var o=e+t.image.x,i=a+t.image.y,n=getPixel(t.template.data,e,a),l=getPixel(t.board.data,o,i);if(!validPixel(n,t.image.ignore))return null;if(t.image.pixelize&&(n=nearesColors(n)),!pixelEquals(n,l)){var d=getColorIndex(n);return-1==d&&console.warn("Incorrect color !"),c&&r(),{x:o,y:i,color:d}}return null}function i(t){console.log("Place.."),App.switchColor(t.color),App.putPxl(t.x,t.y),s.alert("Placed at ["+t.x+", "+t.y+"] Color "+t.color,palette[t.color])}function r(){t.board.context.globalAlpha=.5,t.board.context.drawImage(t.template.canvas,t.image.x,t.image.y),t.board.context.globalAlpha=1}var n=countPoints(t.template.data,t.image.ignore),l=0,d=0,p=!0,c=!1,s=function(){var e,o={updatePercent:function(t){e.find("#filledpercent").text("Filled "+t.toFixed(2)+"%")},updateSpeed:function(t){e.find("#fillspeed").text(t+" new piexels")},updateFilled:function(t,a){e.find("#filledpixels").text(a-t+" / "+a+" ("+t+")")},alert:function(t,a){e.find("#alertmsg").text(t),void 0!=a&&e.find("#alertcolor").css("background-color","rgb("+a[0]+","+a[1]+","+a[2]+")")}};return function(){return $("head").append("<style>.xbotpanel {\tpadding: 10px;\tcolor: white;\tbox-shadow: 0 0 15px rgba(0,0,0,0.9);\tbackground-color: rgba(0,0,0,0.8);\tborder-radius: 3px;\tbottom: 110px;\topacity: 0.8;\tright: 20px;    position: absolute;\ttransition: opacity 0.3s ease-in-out;}.xbotpanel:hover {\topacity: 1.0;}.xbotpanel button, .xbotpanel select {\tbackground-color: #109254;\tborder: none;\tcolor: white;\tpadding: 3px 15px;\ttext-align: center;\ttext-decoration: none;\tdisplay: inline-block;\tfont-size: 14px;\tborder-radius: 3px;\twidth: 100%;\tmargin: 2px;\tcursor: pointer;\toutline: none;}.xbotpanel button:hover, .xbotpanel select:hover {\tbackground-color: #137144;}.xbotpanel button.disabled {\tbackground-color: #ff2967;}.xbotpanel a {\tcolor: #109254;}.xbotpanel small {\tcolor: #ccc;}.botalert {\tposition: absolute;\twidth: 100%;\tbottom: 53px;\tbackground-color: rgba(255, 255, 255, 0.8);\tpadding: 5px;\ttext-align: center;\tfont-size: 20px;}.botalert i {\twidth: 10px;\theight: 10px;\tbackground-color: none;\tborder-radius: 50%;\tposition: absolute;\tmargin: 6px;\tborder: 1px solid rgba(0, 0, 0, 0.5);}</style>"),e=$("#ui"),e.append('<div class="xbotpanel"><a target="_blank" title="[Discord]" href="https://discord.gg/7SCbPUe">Ukraine pxls.space</a><br>'+t.image.title+"<br>["+t.image.x+", "+t.image.y+']<br><span id="filledpercent">Filled '+l+'%</span><br><small id="fillspeed" title="at last iteration">0 new pixels</small><br><small id="filledpixels">0 / 0 (0)</small><br><button id="disablebot" title="Disable/Enable bot">On</button><br><button id="restartbot">Restart Bot</button><br><button id="screenshot">Screenshot</button><br><button id="preview">Preview</button><br><select id="selectdir"><option value="0">Random</option><option value="1">Left - Right</option><option value="2">Right - Left</option><option value="3">Top - Bottom</option><option value="4">Bottom - Top</option><option value="5">Chess</option></select></div>'),e.append('<div class="botalert"><span id="alertmsg"></span><i id="alertcolor"></i></div>'),e.find("#selectdir").val(""+t.image.dir),e.find("#restartbot").click(function(){a()}),e.find("#screenshot").click(function(){var e=t.board.canvas,a=new Image;a.src=e.toDataURL("image/png");var o=document.createElement("a");o.setAttribute("download","board.png"),o.setAttribute("href",a.src),o.appendChild(a),o.click()}),e.find("#preview").click(function(){c=!c,c?($(this).addClass("disabled"),r()):($(this).removeClass("disabled"),updateBoardData(t.board))}),e.find("#disablebot").click(function(){p=!p,p?($(this).removeClass("disabled"),$(this).text("On")):($(this).addClass("disabled"),$(this).text("Off"))}),e.find("#selectdir").change(function(e){t.image.dir=parseInt($(this).val())}),o}()}();setTimeout(e,FORCE_DELAY)}function updateBoardData(t){return jQuery.get("/boarddata",function(e){for(var a=t.context,o=new ImageData(App.width,App.height),i=new Uint32Array(o.data.buffer),r=App.palette.map(function(t){return t=hexToRgb(t),4278190080|t.b<<16|t.g<<8|t.r}),n=0;n<App.width*App.height;n++)i[n]=r[e.charCodeAt(n)];a.putImageData(o,0,0)}),t.context.getImageData(0,0,t.canvas.width,t.canvas.height)}function validPixel(t,e){if(t[3]<=127)return!1;for(var a=0;a<e.length;a++)if(pixelEquals(e[a],t))return!1;return!0}function validateTemplate(t,e){for(var a=0;a<t.width;a++)for(var o=0;o<t.height;o++){var i=getPixel(t,a,o);if(validPixel(i,e)&&(!(i[3]<=127)&&getColorIndex(i)))return{valid:!1,pixel:i,x:a,y:o}}return{valid:!0}}function countPoints(t,e){for(var a=0,o=0;o<t.width;o++)for(var i=0;i<t.height;i++){var r=getPixel(t,o,i);validPixel(r,e)&&a++}return a}function getColorIndex(t){for(var e=0;e<palette.length;e++)if(pixelEquals(palette[e],t))return e;return-1}function getPixel(t,e,a){var o=a*t.width*4,i=4*e,r=o+i;return t.data.slice(r,r+4)}function pixelEquals(t,e){return t[0]==e[0]&&t[1]==e[1]&&t[2]==e[2]}function nearesColors(t){for(var e=[],a=0;a<palette.length;a++){var o=colorDistance(palette[a],t);e.push(o)}var i=arrayMinIndex(e);return palette[i]}function arrayMinIndex(t){for(var e=t[0],a=0,o=0;o<t.length;o++)t[o]<e&&(e=t[o],a=o);return a}function colorDistance(t,e){return Math.abs(t[0]-e[0])+Math.abs(t[1]-e[1])+Math.abs(t[2]-e[2])}var palette=[[255,255,255],[228,228,228],[136,136,136],[34,34,34],[255,167,209],[229,0,0],[229,149,0],[160,106,66],[229,217,0],[148,224,68],[2,190,1],[0,211,221],[0,131,199],[0,0,234],[207,110,228],[130,0,128]];UBot.prototype.start=function(){var t={image:new Image,canvas:document.createElement("canvas"),context:null,data:null},e={canvas:App.elements.board[0],context:null,data:null};t.context=t.canvas.getContext("2d"),e.context=e.canvas.getContext("2d"),this.template=t,this.board=e;var a=this;t.image.onload=function(){if(t.canvas.width=t.image.width,t.canvas.height=t.image.height,t.context.drawImage(t.image,0,0),e.data=updateBoardData(e),t.data=t.context.getImageData(0,0,t.image.width,t.image.height),!a.image.pixelize){var o=validateTemplate(t.data,a.image.ignore);if(!o.valid)return void App.alert("Incorrect color "+o.pixel+" at ["+o.x+", "+o.y+"]");console.log("Template valid true")}launchBot(a)},t.image.crossOrigin="anonymous",t.image.src=this.image.src};var FORCE_DELAY=100,WAIT_DELAY=100,DRAW_DELAY=50;